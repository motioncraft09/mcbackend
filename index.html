<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motioncraft — Full Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
:root{
  --bg:#f6f7f9; --card:#fff; --muted:#6b7280; --accent:#0f172a; --success:#10b981; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--accent);}
.header{background:#fff;padding:12px 18px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;flex-wrap:wrap}
.header h1{margin:0;font-size:18px}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.summary{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.sum-card{min-width:150px;flex:1;padding:12px;border-radius:10px}
.kv{color:var(--muted);font-size:13px}
.huge{font-size:18px;font-weight:700}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.input,select,button{padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
.button{background:#111;color:#fff;border:0;cursor:pointer;padding:8px 12px;border-radius:8px}
.small{padding:6px 8px;border-radius:8px;border:0;background:#111;color:#fff}
.table-wrap{overflow:auto;border-radius:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;border-bottom:1px solid #f3f4f6;text-align:left;font-size:14px}
th{background:#fafafa;color:var(--muted);font-weight:600}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:700;font-size:12px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;padding:16px}
.modal-box{background:#fff;width:100%;max-width:900px;border-radius:12px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-body{padding:16px;overflow:auto}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.form-grid{grid-template-columns:1fr}}
.modal-footer{padding:12px 16px;border-top:1px solid #f3f4f6;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
.noscroll{overflow:hidden}
.dark{background:#0b1020;color:#e6eef8}
.dark .card{background:#071026}
.small-kv{font-size:12px;color:var(--muted)}
.right{margin-left:auto}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.csv-btn{background:#06b6d4;color:#fff;border:0;padding:6px 8px;border-radius:8px}
@media(max-width:600px){
  .header{flex-direction:column;align-items:flex-start;gap:8px}
  .controls{flex-direction:column}
  .controls > div{width:100%;}
  .grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <h1>Motioncraft — Owner Dashboard</h1>
    <span class="small-kv">Admin</span>
  </div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button id="darkToggle" class="small">Dark</button>
    <button id="logoutBtn" class="small">Logout</button>
  </div>
</div>

<div class="container" id="app">

  <!-- LOGIN UI -->
  <div id="loginCard" class="card" style="max-width:420px;margin:40px auto">
    <h3>Admin Login</h3>
    <div class="kv">Enter dashboard password</div>
    <input id="loginPass" class="input" placeholder="password" style="width:100%;margin-top:8px;margin-bottom:12px">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="button" onclick="doLogin()">Login</button>
      <button class="button" onclick="fillDemo()">Demo (no API)</button>
    </div>
    <div class="small-kv" style="margin-top:8px">Default demo password: <strong>hasib123$</strong></div>
  </div>

  <!-- MAIN UI -->
  <div id="mainUI" style="display:none">

    <div class="summary">
      <div class="sum-card card">
        <div class="kv">Total Orders</div>
        <div id="totalOrders" class="huge">0</div>
        <div class="small-kv" id="activeOrders">0 active</div>
      </div>
      <div class="sum-card card">
        <div class="kv">Pending Payments</div>
        <div id="pendingPayments" class="huge">0</div>
        <div class="small-kv">Orders with pending</div>
      </div>
      <div class="sum-card card">
        <div class="kv">This Month Income</div>
        <div id="thisMonthIncome" class="huge">0 BDT</div>
        <div class="small-kv">Converted currency view</div>
      </div>
      <div class="sum-card card">
        <div class="kv">Team Members</div>
        <div id="teamCount" class="huge">0</div>
        <div class="small-kv">Editors tracked</div>
      </div>
    </div>

    <div class="controls">
      <button class="button" onclick="openOrderModal()">+ New Order</button>

      <select id="filterMonth" class="input">
        <option value="">All Months</option>
      </select>

      <select id="filterEditor" class="input">
        <option value="">All Editors</option>
      </select>

      <select id="displayCurrency" class="input">
        <option value="BDT">Display BDT</option>
        <option value="USD">Display USD</option>
      </select>

      <input id="searchBox" class="input" placeholder="Search order ID or client" oninput="renderAll()">

      <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
        <button class="csv-btn" onclick="exportCSV()">Export CSV</button>
        <button class="small" onclick="openTeamModal()">Add Team</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Orders</h3>
        <div class="table-wrap" style="margin-top:10px">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>Order</th><th>Client</th><th>Phone</th><th>Service</th><th>Price</th><th>Paid</th><th>EditorBudget</th><th>Editor</th><th>Status</th><th>Month</th><th>WA</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card">
          <h3 style="margin-top:0">Team Workload</h3>
          <div id="teamList"></div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Monthly Summary</h3>
          <div id="monthSummary"></div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Profit Calculator</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
            <input id="pc_income" class="input" placeholder="Income amount">
            <select id="pc_income_cur" class="input"><option>BDT</option><option>USD</option></select>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
            <input id="pc_expense" class="input" placeholder="Expense amount">
            <select id="pc_expense_cur" class="input"><option>BDT</option><option>USD</option></select>
          </div>
          <button class="button" onclick="calcProfit()">Calculate</button>
          <div id="profitResult" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- Transactions / Payments manager -->
    <div style="margin-top:12px" class="card">
      <h3 style="margin-top:0">Transactions (Payments & Expenses)</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <select id="tx_type" class="input"><option value="payment">Payment</option><option value="expense">Expense</option></select>
        <input id="tx_order" class="input" placeholder="Related Order ID (optional)">
        <input id="tx_editor" class="input" placeholder="Editor (optional)">
        <input id="tx_client" class="input" placeholder="Client (optional)">
        <input id="tx_amount" class="input" placeholder="Amount">
        <select id="tx_currency" class="input"><option>BDT</option><option>USD</option></select>
        <input id="tx_note" class="input" placeholder="Note">
        <button class="button" onclick="addTransaction()">Add</button>
      </div>

      <div class="table-wrap">
        <table id="txTable">
          <thead><tr><th>TX ID</th><th>Type</th><th>Order</th><th>Editor</th><th>Client</th><th>Amount</th><th>Currency</th><th>Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- ORDER MODAL -->
<div id="orderModal" class="modal"><div class="modal-box">
  <div class="modal-body">
    <h3>New Order</h3>
    <div class="form-grid" style="margin-top:8px">
      <div><input id="m_order_id" class="input" placeholder="Order ID (optional)"></div>
      <div><input id="m_client" class="input" placeholder="Client name"></div>
      <div><input id="m_phone" class="input" placeholder="+88017..."></div>
      <div><input id="m_service" class="input" placeholder="Service"></div>
      <div><input id="m_price" class="input" type="number" placeholder="Price"></div>
      <div><select id="m_currency" class="input"><option>BDT</option><option>USD</option></select></div>
      <div><input id="m_paid" class="input" type="number" placeholder="Paid amount (optional)"></div>
      <div><input id="m_editor_budget" class="input" type="number" placeholder="Editor budget"></div>
      <div><select id="m_editor" class="input"><option value="">Unassigned</option><option>Siam</option><option>Mojid</option><option>Samiul</option></select></div>
      <div><select id="m_status" class="input"><option>Fresh</option><option>Scripting</option><option>Editing</option><option>Correction</option><option>Final Delivery</option><option>Completed</option></select></div>
      <div style="grid-column:1/-1"><input id="m_notes" class="input" placeholder="Notes"></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="small" onclick="closeOrderModal()" style="background:#ef4444">Cancel</button>
    <button class="button" onclick="saveOrderModal()">Save Order</button>
  </div>
</div></div>

<!-- TEAM MODAL -->
<div id="teamModal" class="modal"><div class="modal-box">
  <div class="modal-body">
    <h3>Add Team Member</h3>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <input id="t_name" class="input" placeholder="Name">
      <input id="t_phone" class="input" placeholder="Phone">
      <input id="t_email" class="input" placeholder="Email">
      <select id="t_role" class="input"><option>Editor</option><option>Manager</option></select>
    </div>
  </div>
  <div class="modal-footer">
    <button class="small" onclick="closeTeamModal()" style="background:#ef4444">Cancel</button>
    <button class="button" onclick="saveTeamMember()">Add</button>
  </div>
</div></div>

<script>
// ---------- CONFIG ----------
let API_BASE = ""; // Your Apps Script Web App URL
let EXCHANGE_RATE = 120.5;
const DEMO_PASSWORD = "hasib123$";

let authed = false;
let orders = [], transactions = [], team = [];

// ---------- LOGIN ----------
function doLogin(){
  const pass = document.getElementById('loginPass').value;
  if(pass === DEMO_PASSWORD){
    authed = true;
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('mainUI').style.display = 'block';
    initApp();
  } else alert('Wrong password. Try demo password or configure API.');
}
function fillDemo(){
  authed = true;
  document.getElementById('loginCard').style.display = 'none';
  document.getElementById('mainUI').style.display = 'block';
  API_BASE = "";
  initApp();
}
document.getElementById('logoutBtn').addEventListener('click', ()=> location.reload());
document.getElementById('darkToggle').addEventListener('click', ()=> document.body.classList.toggle('dark'));

// ---------- INIT ----------
function initApp(){
  const sel = document.getElementById('filterMonth');
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const now = new Date();
  const opts = ['<option value="">All Months</option>'];
  for(let i=0;i<12;i++){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    opts.push(`<option value="${monthNames[d.getMonth()]}">${monthNames[d.getMonth()]} ${d.getFullYear()}</option>`);
  }
  sel.innerHTML = opts.join('');
  loadAll();
}

// ---------- API HELPERS ----------
async function apiGet(sheet){ if(!API_BASE) return Promise.resolve([]); try{ const res = await fetch(API_BASE+"?sheet="+encodeURIComponent(sheet)); return await res.json(); }catch(e){ console.warn("GET failed",e); return []; } }
async function apiPost(body){ if(!API_BASE) return Promise.resolve({success:true}); try{ const res = await fetch(API_BASE,{method:'POST',body:JSON.stringify(body)}); return await res.json(); }catch(e){ console.error('POST failed',e); return { success:false,error:e.toString() }; } }

// ---------- LOAD & RENDER ----------
async function loadAll(){
  [orders, team, transactions] = await Promise.all([apiGet('Orders'), apiGet('Team'), apiGet('Transactions')]);
  orders = Array.isArray(orders)?orders:[];
  team = Array.isArray(team)?team:[];
  transactions = Array.isArray(transactions)?transactions:[];
  renderAll();
  renderTransactions();
}

function renderAll(){
  const norm = orders.map(o=>({
    order_id: o.order_id||o.id||o.ID||'',
    client: o.client||o.client_name||'',
    phone: o.phone||o.client_phone||'',
    service: o.service||o.service_type||'',
    status: o.status||'Fresh',
    editor: o.editor||'',
    price: Number(o.price||0),
    currency: o.currency||'BDT',
    editor_budget: Number(o.editor_budget||0),
    month: o.month||(new Date(o.date||Date.now())).toLocaleString('en-US',{month:'long'}),
    paid_amount: Number(o.paid_amount||0)
  }));
  orders = norm;

  const tbody = document.querySelector('#ordersTable tbody');
  tbody.innerHTML = '';
  const selMonth = document.getElementById('filterMonth').value;
  const selEditor = document.getElementById('filterEditor').value;
  const displayCurrency = document.getElementById('displayCurrency').value;
  const search = document.getElementById('searchBox').value.trim().toLowerCase();

  const filtered = orders.filter(o=>{
    if(selMonth && o.month !== selMonth) return false;
    if(selEditor && o.editor !== selEditor) return false;
    if(search && !(o.client.toLowerCase().includes(search)||o.order_id.toLowerCase().includes(search))) return false;
    return true;
  });

  filtered.forEach((o,i)=>{
    let price = convertCurrency(o.price,o.currency,displayCurrency).toFixed(2);
    let paid = convertCurrency(o.paid_amount,o.currency,displayCurrency).toFixed(2);
    tbody.innerHTML += `<tr>
      <td>${o.order_id}</td><td>${o.client}</td><td>${o.phone}</td><td>${o.service}</td><td>${price}</td><td>${paid}</td><td>${o.editor_budget}</td><td>${o.editor}</td><td>${o.status}</td><td>${o.month}</td>
      <td>${o.phone?`<a target="_blank" href="https://wa.me/${o.phone.replace(/\D/g,'')}">WA</a>`:''}</td>
      <td><button class="small" onclick="editOrder(${i})">Edit</button></td>
    </tr>`;
  });

  // UPDATE SUMMARY
  document.getElementById('totalOrders').innerText = orders.length;
  document.getElementById('activeOrders').innerText = orders.filter(o=>o.status!=='Completed').length+' active';
  let pending = orders.reduce((a,o)=>a+Math.max(0,o.price-o.paid_amount),0);
  document.getElementById('pendingPayments').innerText = pending.toFixed(2)+' '+displayCurrency;
  document.getElementById('teamCount').innerText = team.length;

  // TEAM DROPDOWN
  const editorSel = document.getElementById('filterEditor');
  const editors = ['','Siam','Mojid','Samiul'];
  editorSel.innerHTML = editors.map(e=>`<option value="${e}">${e||'All Editors'}</option>`).join('');

  // TEAM WORKLOAD
  renderTeam();
  renderMonthSummary();
}

// ---------- UTILS ----------
function convertCurrency(amount,from,to){
  if(from===to) return amount;
  if(from==='BDT' && to==='USD') return amount/EXCHANGE_RATE;
  if(from==='USD' && to==='BDT') return amount*EXCHANGE_RATE;
  return amount;
}

// ---------- ORDER MODAL ----------
function openOrderModal(){document.getElementById('orderModal').style.display='flex'}
function closeOrderModal(){document.getElementById('orderModal').style.display='none'}
function saveOrderModal(){
  const o = {
    order_id: document.getElementById('m_order_id').value || 'O'+(orders.length+1),
    client: document.getElementById('m_client').value,
    phone: document.getElementById('m_phone').value,
    service: document.getElementById('m_service').value,
    price: Number(document.getElementById('m_price').value),
    currency: document.getElementById('m_currency').value,
    paid_amount: Number(document.getElementById('m_paid').value||0),
    editor_budget: Number(document.getElementById('m_editor_budget').value||0),
    editor: document.getElementById('m_editor').value,
    status: document.getElementById('m_status').value,
    notes: document.getElementById('m_notes').value,
    month: new Date().toLocaleString('en-US',{month:'long'})
  };
  orders.push(o);
  renderAll();
  closeOrderModal();
}

// ---------- EDIT ORDER ----------
function editOrder(idx){
  const o = orders[idx];
  openOrderModal();
  document.getElementById('m_order_id').value=o.order_id;
  document.getElementById('m_client').value=o.client;
  document.getElementById('m_phone').value=o.phone;
  document.getElementById('m_service').value=o.service;
  document.getElementById('m_price').value=o.price;
  document.getElementById('m_currency').value=o.currency;
  document.getElementById('m_paid').value=o.paid_amount;
  document.getElementById('m_editor_budget').value=o.editor_budget;
  document.getElementById('m_editor').value=o.editor;
  document.getElementById('m_status').value=o.status;
  document.getElementById('m_notes').value=o.notes||'';
}

// ---------- TEAM ----------
function openTeamModal(){document.getElementById('teamModal').style.display='flex'}
function closeTeamModal(){document.getElementById('teamModal').style.display='none'}
function saveTeamMember(){
  team.push({
    name: document.getElementById('t_name').value,
    phone: document.getElementById('t_phone').value,
    email: document.getElementById('t_email').value,
    role: document.getElementById('t_role').value
  });
  renderTeam();
  closeTeamModal();
}
function renderTeam(){
  const div = document.getElementById('teamList');
  if(!team.length){div.innerHTML='No members yet.';return;}
  div.innerHTML = '<ul>'+team.map(t=>`<li>${t.name} (${t.role})</li>`).join('')+'</ul>';
}

// ---------- MONTH SUMMARY ----------
function renderMonthSummary(){
  const div = document.getElementById('monthSummary');
  const months = {};
  orders.forEach(o=>{
    if(!months[o.month]) months[o.month]=0;
    months[o.month]+=o.price;
  });
  div.innerHTML = Object.entries(months).map(([m,v])=>`<div>${m}: ${v.toFixed(2)} BDT</div>`).join('');
}

// ---------- PROFIT CALC ----------
function calcProfit(){
  let inc = Number(document.getElementById('pc_income').value||0);
  let exp = Number(document.getElementById('pc_expense').value||0);
  const inc_cur = document.getElementById('pc_income_cur').value;
  const exp_cur = document.getElementById('pc_expense_cur').value;
  inc = convertCurrency(inc,inc_cur,'BDT');
  exp = convertCurrency(exp,exp_cur,'BDT');
  document.getElementById('profitResult').innerText = `Profit: ${ (inc-exp).toFixed(2) } BDT`;
}

// ---------- TRANSACTIONS ----------
function addTransaction(){
  const tx = {
    id: 'TX'+(transactions.length+1),
    type: document.getElementById('tx_type').value,
    order: document.getElementById('tx_order').value,
    editor: document.getElementById('tx_editor').value,
    client: document.getElementById('tx_client').value,
    amount: Number(document.getElementById('tx_amount').value),
    currency: document.getElementById('tx_currency').value,
    note: document.getElementById('tx_note').value,
    date: new Date().toLocaleString()
  };
  transactions.push(tx);
  renderTransactions();
}
function renderTransactions(){
  const tbody = document.querySelector('#txTable tbody');
  tbody.innerHTML = transactions.map(tx=>{
    return `<tr>
      <td>${tx.id}</td>
      <td>${tx.type}</td>
      <td>${tx.order}</td>
      <td>${tx.editor}</td>
      <td>${tx.client}</td>
      <td>${tx.amount}</td>
      <td>${tx.currency}</td>
      <td>${tx.date}</td>
    </tr>`;
  }).join('');
}

// ---------- CSV EXPORT ----------
function exportCSV(){
  let csv = 'Order ID,Client,Phone,Service,Price,Paid,EditorBudget,Editor,Status,Month\n';
  orders.forEach(o=>{
    csv += [o.order_id,o.client,o.phone,o.service,o.price,o.paid_amount,o.editor_budget,o.editor,o.status,o.month].join(',')+'\n';
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='orders.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ---------- EVENT HANDLERS ----------
document.getElementById('filterMonth').addEventListener('change', renderAll);
document.getElementById('filterEditor').addEventListener('change', renderAll);
document.getElementById('displayCurrency').addEventListener('change', renderAll);

</script>
</body>
</html>
